metadata:
  name: serviceprincipalnames-discovery-with-powershell
  version: 9.0.0
  description: The following analytic detects the use of `powershell.exe` to query
    the domain for Service Principal Names (SPNs) using Script Block Logging EventCode
    4104. It identifies the use of the KerberosRequestorSecurityToken class within
    the script block, which is equivalent to using setspn.exe. This activity is significant
    as it often precedes kerberoasting or silver ticket attacks, which can lead to
    credential theft. If confirmed malicious, attackers could leverage this information
    to escalate privile
  author: Michael Haag, Splunk
  tags:
  - ttp
  - splunk-security-content
  - hellcat-ransomware
  - active-directory-discovery
  - active-directory-kerberos-attacks
  mitre_attack:
    techniques:
    - id: T1558.003
      name: Technique T1558.003
    tactics: []
files:
  bundled: []
  references:
  - uri: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1059.001/powershell_script_block_logging/sbl_xml.log
    description: XmlWinEventLog:Microsoft-Windows-PowerShell/Operational - XmlWinEventLog
    format: text
    schema: raw
defaults:
  replay:
    delta_factor: 1.0
    base_time: earliest
    target_time: now-1h
  schema: raw
