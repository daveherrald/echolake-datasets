metadata:
  name: windows-wmi-impersonate-token
  version: 7.0.0
  description: The following analytic detects potential WMI token impersonation activities
    in a process or command. It leverages Sysmon EventCode 10 to identify instances
    where `wmiprvse.exe` has a duplicate handle or full granted access in a target
    process. This behavior is significant as it is commonly used by malware like Qakbot
    for privilege escalation or defense evasion. If confirmed malicious, this activity
    could allow an attacker to gain elevated privileges, evade defenses, and maintain
    persistence with
  author: Teoderick Contreras, Splunk
  tags:
  - anomaly
  - splunk-security-content
  - qakbot
  - water-gamayun
  mitre_attack:
    techniques:
    - id: T1047
      name: Technique T1047
    tactics: []
files:
  bundled: []
  references:
  - uri: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1047/wmi_impersonate/sysmon.log
    description: XmlWinEventLog:Microsoft-Windows-Sysmon/Operational - XmlWinEventLog
    format: auto
    schema: raw
    sourcetype: XmlWinEventLog
defaults:
  replay:
    delta_factor: 1.0
    base_time: earliest
    target_time: now-1h
  schema: raw
